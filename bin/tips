#!/bin/bash

source "$(dirname "$0")/../lib/config.sh"
source "$(dirname "$0")/../lib/core.sh"
source "$(dirname "$0")/../lib/helpers.sh"

# Основная логика
main() {
    init_tips_file
    
    local tip comment
    
    while getopts ":a:c:s:lchvj" opt; do
        case $opt in
            a) 
                tip="$OPTARG"
                shift $((OPTIND-1))
                comment="$*"
                OPTIND=1
                ;;
            s) search_tips "$OPTARG"; exit 0 ;;
            l) list_tips; exit 0 ;;
            h) print_help; exit 0 ;;
            v) echo "Command Tips v$VERSION"; exit 0 ;;
            j) tip="$(get_last_command)" ;;

            \?) print_message red "Неверный флаг: -$OPTARG"; print_help; exit 1 ;;
            :) print_message red "Опция -$OPTARG требует аргумент"; print_help; exit 1 ;;
        esac
    done
    
    shift $((OPTIND-1))
    
    # Обработка длинных флагов
    case "$1" in
        --clear) clear_tips ;;
        --list) list_tips ;;
        --help) print_help ;;
        --count) echo "Всего подсказок: $(count_tips)" ;;
        --*) print_message red "Неизвестный флаг: $1"; print_help; exit 1 ;;
    esac
    
    # Добавление подсказки (если указана)
    [ -n "$tip" ] && add_tip "$tip" "$comment"
    
    # Если не передано ни одного аргумента
    [ $OPTIND -eq 1 ] && print_help
}

main "$@"